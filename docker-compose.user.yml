services:
  egl:
    container_name: ${CONTAINER_NAME:-devcontainer-egl-desktop-${USER}}
    hostname: ${CONTAINER_HOSTNAME:-egl}
    # Use user-specific image built with build-user-image.sh
    image: ${USER_IMAGE:-devcontainer-ubuntu-egl-desktop-${USER}:24.04}
    runtime: ${GPU_RUNTIME:-runc}
    
    # GPU configuration - For NVIDIA, uncomment runtime line below
    # runtime: nvidia
    
    ports:
    # HTTPS/HTTP port (UID-based: 10000 + UID)
    - '${HTTPS_PORT:-8080}:8080'
    # KasmVNC ports (only used when VNC_TYPE=kasm)
    - '${KASM_WEBSOCKET_PORT:-6900}:${KASM_WEBSOCKET_PORT:-6900}'
    - '${KCLIENT_PORT:-3000}:${KCLIENT_PORT:-3000}'
    - '${KASMAUDIO_PORT:-4900}:${KASMAUDIO_PORT:-4900}'
    - '${NGINX_KASM_PORT:-12000}:${NGINX_KASM_PORT:-12000}'
    # Internal TURN server ports (only used when VNC_TYPE=selkies and ENABLE_TURN=true)
    - '${TURN_PORT:-3478}:3478'
    - '${TURN_PORT:-3478}:3478/udp'
    - '${UDP_PORT_START:-65532}-${UDP_PORT_END:-65535}:${UDP_PORT_START:-65532}-${UDP_PORT_END:-65535}/udp'
    
    stdin_open: true
    tty: true
    
    # GPU device configuration
    # Note: For NVIDIA GPUs, uncomment the deploy section below and runtime above
    # For Intel/AMD GPUs, the bind mount + cgroup rules below are sufficient
#    deploy:
#      resources:
#        reservations:
#          devices:
#          - driver: nvidia
#            count: all
#            capabilities: [gpu]
    
    # Add video and render groups for GPU access
    group_add:
      - ${VIDEO_GID:-44}
      - ${RENDER_GID:-109}
    
    # Allow DRM (226) devices inside the container when mounted via bind
    device_cgroup_rules:
      - 'c 226:* rwm'
    
    # Set to true for Intel GPU
    privileged: ${PRIVILEGED:-false}
    
    tmpfs:
    - '/dev/shm:rw'
    
    volumes:
    # Bind-mount /dev/dri for GPU access. create_host_path prevents docker compose
    # from failing on hosts without GPU devices (e.g. WSL) by creating the
    # directory when it does not exist.
    - type: bind
      source: /dev/dri
      target: /dev/dri
      bind:
        create_host_path: true
    # Mount user home directory as host_home
    - type: bind
      source: ${HOME}
      target: /home/${USER}/host_home
    # Mount custom SSL certificates (auto-created if missing)
    - type: bind
      source: ${SSL_CERT_DIR:-./ssl}
      target: /etc/ssl/custom
      read_only: true
      bind:
        create_host_path: true
    # Mount host PulseAudio (for noVNC mode)
    - type: bind
      source: ${PULSE_PATH:-./.pulse-host}
      target: /tmp/pulse-host
      read_only: true
      bind:
        create_host_path: true
    
    # Uncomment the below line to disable network isolation for WebRTC connectivity
#    network_mode: 'host'
    
    environment:
    # Display settings
    - TZ=${TZ:-UTC}
    - DISPLAY_SIZEW=${DISPLAY_WIDTH:-1920}
    - DISPLAY_SIZEH=${DISPLAY_HEIGHT:-1080}
    - DISPLAY_REFRESH=${DISPLAY_REFRESH:-60}
    - DISPLAY_DPI=96
    - DISPLAY_CDEPTH=24
    - USE_XORG=${USE_XORG:-false}
    
    # Keyboard layout (auto-detected from host or set manually)
    - KEYBOARD_LAYOUT=${KEYBOARD_LAYOUT:-us}
    - KEYBOARD_VARIANT=${KEYBOARD_VARIANT:-}
    - KEYBOARD_MODEL=${KEYBOARD_MODEL:-pc105}
    
    # GPU support (set by GPU_VENDOR: nvidia=true, others=false)
    - ENABLE_NVIDIA=${ENABLE_NVIDIA:-false}
    - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-}
    
    # VA-API configuration (for Intel/AMD GPUs)
    - LIBVA_DRIVER_NAME=${LIBVA_DRIVER_NAME:-}
    
    # User password (set during image build)
    - PASSWD=${USER_PASSWORD:-mypasswd}
    
    # VNC type: selkies (default), kasm, novnc
    - VNC_TYPE=${VNC_TYPE:-selkies}
    - KASMVNC_ENABLE=${KASMVNC_ENABLE:-false}
    - KASMVNC_THREADS=${KASMVNC_THREADS:-0}
    
    ###
    # Selkies parameters
    ###
    # Video encoder: nvh264enc (NVIDIA), vah264enc (Intel/AMD), x264enc (software)
    - SELKIES_ENCODER=${VIDEO_ENCODER:-nvh264enc}
    - SELKIES_ENABLE_RESIZE=false
    - SELKIES_VIDEO_BITRATE=${VIDEO_BITRATE:-8000}
    - SELKIES_FRAMERATE=${FRAMERATE:-60}
    - SELKIES_AUDIO_BITRATE=${AUDIO_BITRATE:-128000}
    - SELKIES_CONGESTION_CONTROL=${SELKIES_CONGESTION_CONTROL:-false}
    
    # Authentication
    - SELKIES_ENABLE_BASIC_AUTH=true
    - SELKIES_BASIC_AUTH_PASSWORD=${USER_PASSWORD:-mypasswd}

    # HTTPS configuration
    - SELKIES_ENABLE_HTTPS=${ENABLE_HTTPS:-true}
    - SELKIES_HTTPS_CERT=${SELKIES_HTTPS_CERT:-}
    - SELKIES_HTTPS_KEY=${SELKIES_HTTPS_KEY:-}
    - SELKIES_ENABLE_RESIZE=${SELKIES_ENABLE_RESIZE:-true}

    ###
    # TURN server configuration (for Selkies remote access)
    ###
    - SELKIES_TURN_HOST=${SELKIES_TURN_HOST:-}
    - SELKIES_TURN_PORT=${SELKIES_TURN_PORT:-}
    - SELKIES_TURN_PROTOCOL=${SELKIES_TURN_PROTOCOL:-udp}
    - SELKIES_TURN_TLS=false
    
    # Internal TURN server settings
    - TURN_MIN_PORT=${UDP_PORT_START:-65532}
    - TURN_MAX_PORT=${UDP_PORT_END:-65535}
    - TURN_LISTENING_PORT=3478
    - TURN_EXTERNAL_IP=${TURN_EXTERNAL_IP:-}
    
    # TURN authentication
    - SELKIES_TURN_SHARED_SECRET=${SELKIES_TURN_SHARED_SECRET:-}
    - SELKIES_TURN_USERNAME=${SELKIES_TURN_USERNAME:-}
    - SELKIES_TURN_PASSWORD=${SELKIES_TURN_PASSWORD:-}
    
    # PulseAudio configuration (for noVNC)
    - PULSE_SERVER=${CONTAINER_PULSE_SERVER:-${PULSE_SERVER:-}}

#volumes:
#  egl-cache-vol:
